<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNTITLED DICE GAME</title>

    <!-- Preconnect to Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Rajdhani:wght@400;700&family=Permanent+Marker&family=Black+Ops+One&family=Comic+Neue:wght@400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

    <!-- Game Styles -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/player-view.css">

    <!-- Supabase Client (for multiplayer) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé≤</text></svg>">
</head>
<body>
    <!-- ==================== TITLE SCREEN ==================== -->
    <div id="titleScreen" class="screen title-screen">
        <div class="title-logo">
            <div class="title-dice">üé≤</div>
            <h1>UNTITLED DICE GAME</h1>
            <p class="subtitle">A Cooperative Dice Adventure</p>
        </div>
        <div class="title-menu">
            <!-- Solo Mode -->
            <div id="soloSection" class="mode-section">
                <button id="soloBtn" class="menu-btn primary solo-btn" onclick="showSoloMenu()">
                    üéÆ Solo Game
                </button>
                <div id="soloSaveInfo" class="save-info-mini" style="display:none;"></div>
            </div>

            <!-- Multiplayer Mode -->
            <div id="multiplayerSection" class="mode-section">
                <button id="multiplayerBtn" class="menu-btn multiplayer-btn" onclick="showMultiplayerGameMenu()">
                    üåê Multiplayer Game
                </button>
                <div id="multiSaveInfo" class="save-info-mini" style="display:none;"></div>
            </div>

            <button class="menu-btn secondary" onclick="showHowToPlay()">How to Play</button>
        </div>
        <div class="loading-tip" id="loadingTip">
            <span class="tip-label">TIP:</span>
            <span id="tipText">Intertwining is powerful. Use it.</span>
        </div>
        <div class="version">v0.5.0</div>
    </div>

    <!-- ==================== HOW TO PLAY SCREEN ==================== -->
    <div id="howtoScreen" class="screen howto-screen hidden">
        <div class="howto-content">
            <h1>How to Play</h1>

            <div class="howto-section">
                <h2>The Basics</h2>
                <p>UNTITLED DICE GAME is a cooperative dice-rolling adventure for 3 players (or 1 player controlling 3 heroes). Navigate through encounters, roll dice to overcome challenges, and work together to complete the prophecy!</p>
            </div>

            <div class="howto-section">
                <h2>The Three Dice Types</h2>
                <div class="dice-type-preview">
                    <div class="type-preview physical">
                        <h4>Physical</h4>
                        <ul>
                            <li>Slash</li>
                            <li>Stab</li>
                            <li>Bonk</li>
                        </ul>
                    </div>
                    <div class="type-preview verbal">
                        <h4>Verbal</h4>
                        <ul>
                            <li>Threaten</li>
                            <li>Deceive</li>
                            <li>Persuade</li>
                        </ul>
                    </div>
                    <div class="type-preview preventative">
                        <h4>Preventative</h4>
                        <ul>
                            <li>Bribe</li>
                            <li>Hide</li>
                            <li>Grapple</li>
                        </ul>
                    </div>
                </div>
                <p>Each player chooses one die from each category, giving them 3 unique dice to roll.</p>
            </div>

            <div class="howto-section">
                <h2>DOOM & HOPE</h2>
                <p><strong>DOOM</strong> (red): Grows when you fail. At high DOOM, your rolls are penalized. If a DOOM roll hits 1... game over.</p>
                <p><strong>HOPE</strong> (green): Bankable charges that can save you from a fatal DOOM roll. Earned by rolling natural 20s!</p>
                <p><strong>SHIELD</strong> (blue): Prevents DOOM rolls entirely. Very powerful but rare.</p>
            </div>

            <div class="howto-section">
                <h2>Dice Intertwining</h2>
                <p>The core innovation: you can LINK your dice to your allies! When you roll a linked number, your ally's die rolls instead. This lets you cover each other's weaknesses and create powerful combos.</p>
            </div>

            <button class="menu-btn back-btn" onclick="closeHowToPlay()">Back to Menu</button>
        </div>
    </div>

    <!-- ==================== SAVE SLOT SCREEN ==================== -->
    <div id="saveSlotScreen" class="screen hidden" style="background:rgba(0,0,0,0.95); padding:40px;">
        <div style="max-width:600px; margin:0 auto; text-align:center;">
            <h1 id="saveSlotTitle" style="font-family:'Cinzel',serif; color:#ffd700; margin-bottom:30px;">Select Save Slot</h1>
            <div id="saveSlots" class="save-slots"></div>
        </div>
    </div>

    <!-- ==================== ACTION ASSIGNMENT SCREEN ==================== -->
    <div id="actionAssignScreen" class="screen hidden" style="background:rgba(0,0,0,0.95); padding:20px; overflow-y:auto;">
        <div class="action-assign-container">
            <h1 style="font-family:'Cinzel',serif; color:#ffd700; text-align:center; margin-bottom:10px;">Choose Your Actions</h1>
            <p style="text-align:center; color:#888; margin-bottom:30px;">Drag each color to one action per category. Each player gets one Physical, one Verbal, and one Preventative die.</p>

            <div class="color-tokens-area">
                <h3>Your Heroes</h3>
                <div class="color-tokens">
                    <div class="color-token player-1" draggable="true" data-player="1">
                        <span class="token-icon"><img src="assets/blue-wizard.png" alt="Blue Wizard" style="width:50px;height:50px;border-radius:10px;"></span>
                        <span class="token-name">Blue</span>
                    </div>
                    <div class="color-token player-2" draggable="true" data-player="2">
                        <span class="token-icon"><img src="assets/red-ranger.png" alt="Red Ranger" style="width:50px;height:50px;border-radius:10px;"></span>
                        <span class="token-name">Red</span>
                    </div>
                    <div class="color-token player-3" draggable="true" data-player="3">
                        <span class="token-icon"><img src="assets/green-pirate.png" alt="Green Pirate" style="width:50px;height:50px;border-radius:10px;"></span>
                        <span class="token-name">Green</span>
                    </div>
                </div>
            </div>

            <div class="action-categories">
                <!-- Physical Category -->
                <div class="action-category physical-category">
                    <div class="category-title physical-title">PHYSICAL</div>
                    <div class="action-slots">
                        <div class="action-slot" data-category="physical" data-action="slash" data-slot="0">
                            <div class="slot-header">SLASH</div>
                            <div class="slot-dropzone"></div>
                        </div>
                        <div class="action-slot" data-category="physical" data-action="stab" data-slot="1">
                            <div class="slot-header">STAB</div>
                            <div class="slot-dropzone"></div>
                        </div>
                        <div class="action-slot" data-category="physical" data-action="bonk" data-slot="2">
                            <div class="slot-header">BONK</div>
                            <div class="slot-dropzone"></div>
                        </div>
                    </div>
                </div>

                <!-- Verbal Category -->
                <div class="action-category verbal-category">
                    <div class="category-title verbal-title">VERBAL</div>
                    <div class="action-slots">
                        <div class="action-slot" data-category="verbal" data-action="threaten" data-slot="0">
                            <div class="slot-header">THREATEN</div>
                            <div class="slot-dropzone"></div>
                        </div>
                        <div class="action-slot" data-category="verbal" data-action="deceive" data-slot="1">
                            <div class="slot-header">DECEIVE</div>
                            <div class="slot-dropzone"></div>
                        </div>
                        <div class="action-slot" data-category="verbal" data-action="persuade" data-slot="2">
                            <div class="slot-header">PERSUADE</div>
                            <div class="slot-dropzone"></div>
                        </div>
                    </div>
                </div>

                <!-- Preventative Category -->
                <div class="action-category preventative-category">
                    <div class="category-title preventative-title">PREVENTATIVE</div>
                    <div class="action-slots">
                        <div class="action-slot" data-category="preventative" data-action="bribe" data-slot="0">
                            <div class="slot-header">BRIBE</div>
                            <div class="slot-dropzone"></div>
                        </div>
                        <div class="action-slot" data-category="preventative" data-action="hide" data-slot="1">
                            <div class="slot-header">HIDE</div>
                            <div class="slot-dropzone"></div>
                        </div>
                        <div class="action-slot" data-category="preventative" data-action="grapple" data-slot="2">
                            <div class="slot-header">GRAPPLE</div>
                            <div class="slot-dropzone"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="assignStatus" class="assign-status">
                <p>Drag each color to one action per category. (0/9 assigned)</p>
            </div>

            <button id="confirmAssignBtn" class="start-btn" onclick="confirmActionAssignment()" disabled>Continue to Talent Ranking</button>
        </div>
    </div>

    <!-- ==================== TALENT RANKING SCREEN ==================== -->
    <div id="talentScreen" class="screen hidden" style="background:rgba(0,0,0,0.95); padding:40px;">
        <div style="max-width:700px; margin:0 auto; text-align:center;">
            <h1 style="font-family:'Cinzel',serif; color:#ffd700; margin-bottom:20px;">Talent Ranking</h1>
            <h2 id="talentPlayerName" style="color:#88ccff; margin-bottom:15px;">Player Name</h2>
            <p id="talentInstruction" style="color:#ccc; margin-bottom:30px;">Choose your BEST talent:</p>
            <div id="talentDiceOptions" class="talent-options"></div>
            <p id="talentHint" class="talent-hint"></p>
        </div>
    </div>

    <!-- ==================== INTERTWINE SCREEN ==================== -->
    <div id="intertwineScreen" class="screen hidden" style="background:rgba(0,0,0,0.95); padding:40px;">
        <div style="max-width:700px; margin:0 auto; text-align:center;">
            <h1 style="font-family:'Cinzel',serif; color:#ffd700; margin-bottom:10px;">Intertwine Your Fates</h1>
            <p id="intertwineSubtitle" style="color:#c084fc; margin-bottom:30px;"></p>
            <div id="intertwineContent"></div>
        </div>
    </div>

    <!-- ==================== SETUP SCREEN (Legacy - Hidden) ==================== -->
    <div id="setupScreen" class="screen setup-screen hidden">
        <!-- Legacy setup screen - not used -->
    </div>

    <!-- ==================== MAIN GAME SCREEN ==================== -->
    <div id="gameScreen" class="screen game-screen hidden">
        <div class="game-container">
            <!-- Header -->
            <header class="header">
                <h1 id="currentFloor">Stage 0: A Dream of Pal</h1>
                <div class="floor-info">
                    <span id="goldDisplay" class="gold">0G</span>
                </div>
                <div class="doom-hope-display">
                    <div class="doom-meter">
                        <span>DOOM:</span>
                        <span id="doomDisplay">0</span>
                    </div>
                    <div class="hope-meter">
                        <span>HOPE:</span>
                        <span id="hopeDisplay" class="hope-charge"></span>
                    </div>
                    <div class="shield-meter">
                        <span>SHIELD:</span>
                        <span id="shieldDisplay" class="shield-charge"></span>
                    </div>
                </div>
                <div class="header-buttons">
                    <button class="header-btn inventory-btn" onclick="showInventory()" title="Use Items">üéí</button>
                    <button class="header-btn shop-btn" onclick="showConsumablesShop()" title="Item Shop">üõí</button>
                    <button class="header-btn" onclick="showPauseMenu()">Menu</button>
                </div>
            </header>

            <!-- Main Area -->
            <main class="main-area">
                <!-- Players Panel -->
                <aside class="players-panel">
                    <h3>Heroes</h3>
                    <div id="playersDisplay"></div>
                </aside>

                <!-- Encounter Panel -->
                <section class="encounter-panel">
                    <div id="encounterContent" class="encounter-content">
                        <div class="encounter-header">
                            <h2 id="encounterTitle">Choose your path</h2>
                            <span id="encounterType" class="encounter-type" style="display:none;"></span>
                        </div>
                        <div id="encounterDescription" class="encounter-description">
                            <p>Select an available location on the map.</p>
                        </div>
                        <div id="encounterOptions" class="encounter-options"></div>
                    </div>
                </section>

                <!-- Map Panel -->
                <aside class="map-panel">
                    <h2>Map</h2>
                    <div id="mapContainer" class="map-container"></div>
                </aside>
            </main>

            <!-- Dice Tray -->
            <footer class="dice-tray">
                <div class="dice-tray-header">
                    Roll Your Dice
                    <button id="soloDiceToggle" class="solo-dice-toggle" onclick="toggleSoloDicePanel()" style="display:none;" title="View All Dice Faces">
                        üìä All Dice
                    </button>
                </div>
                <div id="diceTray" class="dice-grid"></div>
            </footer>

            <!-- Solo Mode Dice Overview Panel (Hidden by default) -->
            <div id="soloDicePanel" class="solo-dice-panel hidden">
                <div class="solo-dice-header">
                    <h3>All Dice Faces</h3>
                    <button class="solo-dice-close" onclick="toggleSoloDicePanel()">√ó</button>
                </div>
                <div id="soloDiceContent" class="solo-dice-content"></div>
            </div>

            <!-- Game Log -->
            <div id="gameLog" class="game-log">
                <h4>Log</h4>
            </div>
        </div>
    </div>

    <!-- ==================== STAGE SHOP SCREEN ==================== -->
    <div id="stageShopScreen" class="screen hidden" style="background:rgba(0,0,0,0.95);">
        <div class="shop-container">
            <h1>Stage Complete!</h1>
            <p style="color:#888; margin-bottom:20px;">Spend your Favor to upgrade before the next stage.</p>
            <div class="shop-points">
                Favor Points: <span id="favorDisplay">0</span>
            </div>
            <div id="shopPlayers" class="shop-players"></div>
            <div class="shop-footer">
                <button class="menu-btn primary" onclick="continueFromShop()">Continue to Next Stage</button>
            </div>
        </div>
    </div>

    <!-- ==================== ROLL RESULT MODAL ==================== -->
    <div id="rollResult" class="modal roll-result">
        <div class="roll-result-content">
            <h2 id="rollDieName">Die Name</h2>
            <div id="swapTriggered" class="swap-triggered" style="display:none;"></div>
            <div id="rollValue" class="result-value">20</div>
            <div id="doomChange" class="doom-change" style="display:none;"></div>
            <p id="rollOutcome" class="outcome">Success!</p>
            <button onclick="closeRollResult()">Continue</button>
        </div>
    </div>

    <!-- ==================== UPGRADE MODAL ==================== -->
    <div id="upgradeModal" class="modal upgrade-modal">
        <div class="modal-content">
            <h2 id="upgradeTitle">Choose an Upgrade</h2>
            <p id="upgradeDescription">Select an option:</p>
            <div id="upgradeOptions" class="upgrade-options"></div>
        </div>
    </div>

    <!-- ==================== PAUSE MODAL ==================== -->
    <div id="pauseModal" class="modal pause-modal">
        <div class="modal-content">
            <h2>Paused</h2>
            <div class="pause-menu">
                <button class="menu-btn" onclick="closePauseMenu()">Resume</button>
                <button class="menu-btn" onclick="saveGame(); closePauseMenu();">Save Game</button>
                <button class="menu-btn" onclick="quitToMenu()">Quit to Menu</button>
            </div>
        </div>
    </div>

    <!-- ==================== DEFEAT SCREEN ==================== -->
    <div id="defeatScreen" class="screen end-screen defeat hidden" style="background:rgba(20,0,0,0.95);">
        <div class="end-content">
            <h1>DEFEAT</h1>
            <p id="defeatReason">The prophecy has failed...</p>
            <p>The darkness claims another set of heroes.</p>
            <div class="end-buttons">
                <button class="menu-btn primary" onclick="restartGame()">Try Again</button>
            </div>
        </div>
    </div>

    <!-- ==================== VICTORY SCREEN ==================== -->
    <div id="victoryScreen" class="screen end-screen victory hidden" style="background:rgba(0,20,0,0.95);">
        <div class="end-content">
            <h1>VICTORY!</h1>
            <p>The 20th Prophecy is fulfilled!</p>
            <p>The Chosen Ones have saved the world.</p>
            <div class="end-buttons">
                <button class="menu-btn primary" onclick="restartGame()">Play Again</button>
            </div>
        </div>
    </div>

    <!-- ==================== JAVASCRIPT MODULES ==================== -->
    <script src="js/config.js"></script>
    <script src="js/state.js"></script>
    <script src="js/save.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/dice.js"></script>
    <script src="js/combat.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/encounters.js"></script>
    <script src="js/screens.js"></script>
    <script src="js/main.js"></script>
    <script src="js/multiplayer.js"></script>
    <script src="js/draftModes.js"></script>
    <!-- Player View System -->
    <script src="js/confirmation.js"></script>
    <script src="js/dice3d.js"></script>
    <script src="js/playerView.js"></script>
</body>
</html>
